{% extends "_base.html" %}
{% load static %}

{% block content %}

<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Configuraci칩n de la cuenta</h1>
    <form id="mainForm" action="{% url 'appAjustes:configuracion_cuenta' %}" method="post" class="space-y-4">
        {% csrf_token %}
        
        <div class="flex items-center space-x-4">
            <img id="profileImage" src="{{ user.foto_perfil.url }}" alt="Perfil" class="w-16 h-16 rounded-full cursor-pointer">
            {{ form_datos }}
        </div>
        
        <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Guardar cambios</button>
        <input class="hidden" type="file" id="fileInput" name="foto_perfil" accept="image/*" onchange="document.getElementById('mainForm').submit();">
    </form>

    <div class="mt-4 space-y-2">
        <button id="logout-button" 
                type="button"
                class="confirmation-button bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600"
                data-action="logout"
                data-url="{% url 'appLoginRegistro:logout_confirmation' %}"
                data-confirm-button-id="confirm-logout"
                data-cancel-button-id="cancel-logout"
                data-redirect-url="{% url 'appLoginRegistro:logout' %}">
            Cerrar sesi칩n
        </button>

        <button id="delete-account-button" 
                type="button" 
                class="confirmation-button bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600"
                data-action="delete-account"
                data-url="{% url 'appLoginRegistro:delete_account_confirmation' %}"
                data-confirm-button-id="confirm-delete-account"
                data-cancel-button-id="cancel-delete-account"
                data-redirect-url="{% url 'appLoginRegistro:delete_account' %}">
            Eliminar cuenta
        </button>
    </div>

    <h1 class="text-2xl font-bold mt-8 mb-4">Tus datos</h1>
    <a href="{% url 'appAjustes:ver_datos' %}">Ver tus datos</a>

    <hr class="mb-4">
    <div class="flex justify-center items-center min-h-screen py-6">
        <div class="w-full max-w-md">
            <h1 class="text-2xl font-bold mt-8 mb-4 text-center">Cambiar contrase침a</h1>
            <form method="post" class="w-full bg-white p-8 rounded-lg shadow-md">
                {% csrf_token %}
                {{ form_cambio_pssw }}
                <button type="submit" class="w-full mt-4 bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600">Cambiar Contrase침a</button>
            </form>
            <hr class="mt-8">
        </div>
    </div>
    
    <hr class="mt-8">
</div>

<!-- TODO: Cambiar y poner en otro lado -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const profileImage = document.getElementById('profileImage');
        const fileInput = document.getElementById('fileInput');

        profileImage.onclick = function() {
            fileInput.click();
        };

        fileInput.onchange = function() {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profileImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };
    });

    document.querySelectorAll('.confirmation-button').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            
            var actionType = this.dataset.action;
            var url = this.dataset.url;
            var confirmButtonId = this.dataset.confirmButtonId;
            var cancelButtonId = this.dataset.cancelButtonId;
            var redirectUrl = this.dataset.redirectUrl;
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var response = JSON.parse(xhr.responseText);
                    var modalDiv = document.createElement('div');
                    modalDiv.innerHTML = response.html;
                    document.body.appendChild(modalDiv);
                    document.getElementById(`${actionType}-confirmation-modal`).style.display = 'block';

                    document.getElementById(confirmButtonId).addEventListener('click', function() {
                        window.location.href = redirectUrl;
                    });

                    document.getElementById(cancelButtonId).addEventListener('click', function() {
                        document.getElementById(`${actionType}-confirmation-modal`).style.display = 'none';
                    });
                }
            };
            xhr.send();
        });
    });
</script>
{% endblock content %}



